# ============================================
# ECHELON INDEXER SCHEMA
# ============================================

# ============================================
# CORE ENTITIES
# ============================================

type Agent @entity {
  id: ID! # Agent ID from contract
  walletAddress: String! @index # Execution wallet
  ownerAddress: String! @index # NFT owner
  name: String! # Human-readable name
  strategyType: String! @index # DCA, Arbitrage, Yield, etc.
  riskLevel: Int! # 1-10 scale
  registeredAt: BigInt! # Unix timestamp
  isActive: Boolean! @index # Accepting delegations
  isVerified: Boolean! @index # Verified by Echelon (set by contract owner)
  isOrchestrator: Boolean! @index # Orchestrator badge (manages other agents, no direct trades)
  metadataUri: String! # IPFS/HTTPS metadata

  # Performance Metrics (Computed)
  totalExecutions: BigInt!
  successfulExecutions: BigInt!
  failedExecutions: BigInt!
  pendingExecutions: BigInt!

  # Volume Metrics
  totalVolumeIn: BigDecimal! # Total input volume (wei)
  totalVolumeOut: BigDecimal! # Total output volume (wei)
  totalProfitLoss: BigDecimal! # Cumulative P&L (wei)

  # Reputation Metrics
  winRate: BigDecimal! # Success rate (0-1)
  avgProfitPerTrade: BigDecimal! # Average profit per trade
  maxDrawdown: BigDecimal! # Maximum drawdown observed
  sharpeRatio: BigDecimal! # Risk-adjusted return
  reputationScore: Int! # 0-100 composite score

  # Timestamps
  lastExecutionAt: BigInt # Last activity timestamp
  updatedAt: BigInt! # Last update timestamp

  # Relationships
  executions: [Execution!]! @derivedFrom(field: "agent")
  permissionsReceived: [Permission!]! @derivedFrom(field: "agent")
  redelegationsAsParent: [Redelegation!]! @derivedFrom(field: "parentAgent")
  redelegationsAsChild: [Redelegation!]! @derivedFrom(field: "childAgent")
  dailyStats: [AgentDailyStat!]! @derivedFrom(field: "agent")
  feedbacks: [Feedback!]! @derivedFrom(field: "agent")
  validationRequests: [ValidationRequest!]! @derivedFrom(field: "agent")
  reputationSummary: AgentReputationSummary # 1:1 relationship, set manually

  # ERC-7710 Delegation Relationships
  delegationsCreated: [ERC7710Delegation!]! @derivedFrom(field: "delegatorAgent")
  delegationsReceived: [ERC7710Delegation!]! @derivedFrom(field: "delegateAgent")
}

type Execution @entity {
  id: ID! # executionId from contract
  agent: Agent! # Executing agent
  user: User! # Delegating user

  # Trade Details
  amountIn: BigDecimal! # Input amount (wei)
  amountOut: BigDecimal! # Output amount (wei)
  tokenIn: String! # Input token address
  tokenOut: String! # Output token address
  tokenInSymbol: String # Input token symbol (if known)
  tokenOutSymbol: String # Output token symbol (if known)

  # Results
  profitLoss: BigDecimal! # amountOut - amountIn
  profitLossPercent: BigDecimal! # Percentage gain/loss
  result: ExecutionResult! # PENDING, SUCCESS, FAILURE

  # Timing
  startedAt: BigInt! # Unix timestamp
  completedAt: BigInt # Unix timestamp (null if pending)
  duration: BigInt # Execution duration in seconds

  # Transaction Info
  startTxHash: String! # Start transaction hash
  completeTxHash: String # Complete transaction hash
  blockNumber: BigInt! # Block number of start

  # Gas Info (if available)
  gasUsed: BigInt
  gasPrice: BigInt
}

enum ExecutionResult {
  PENDING
  SUCCESS
  FAILURE
}

type User @entity {
  id: ID! # User wallet address

  # Stats
  totalDelegated: BigDecimal! # Total amount ever delegated
  currentDelegated: BigDecimal! # Currently active delegations
  activePermissions: BigInt! # Count of active permissions
  totalPermissionsGranted: BigInt! # Total permissions ever granted

  # Performance
  totalProfitFromAgents: BigDecimal! # Total profit earned via agents
  bestAgentUsed: Agent # Best performing agent for this user

  # Timestamps
  firstDelegationAt: BigInt # First delegation timestamp
  lastActivityAt: BigInt # Last activity timestamp

  # Relationships
  permissions: [Permission!]! @derivedFrom(field: "user")
  executions: [Execution!]! @derivedFrom(field: "user")
  delegationsInvolved: [ERC7710Delegation!]! @derivedFrom(field: "originalUser")
}

type Permission @entity {
  id: ID! # Permission ID from PermissionRegistry contract (bytes32 as hex)
  user: User! # Granting user
  agent: Agent # Receiving agent (optional - may not be registered yet)
  agentAddress: String! @index # Agent wallet address (always populated)

  # Permission Parameters
  permissionType: String! # erc20-token-periodic, etc.
  tokenAddress: String! # Token being permitted
  tokenSymbol: String # Token symbol
  amountPerPeriod: BigDecimal! # Amount per period (wei)
  periodDuration: BigInt! # Period in seconds
  totalAmount: BigDecimal! # Maximum total (wei)

  # Timing
  grantedAt: BigInt! # Unix timestamp
  expiresAt: BigInt! # Unix timestamp
  revokedAt: BigInt # Unix timestamp (null if active)

  # Status
  isActive: Boolean! @index # Currently active
  amountUsed: BigDecimal! # Amount already used (wei)
  amountRemaining: BigDecimal! # Amount remaining (wei)
  periodsElapsed: BigInt! # Number of periods elapsed

  # On-chain tracking
  permissionHash: String # Hash of the ERC-7715 permission data

  # Transaction Info
  grantTxHash: String! # Grant transaction hash
  revokeTxHash: String # Revoke transaction hash (if revoked)
}

type Redelegation @entity {
  id: ID! # Composite ID
  parentAgent: Agent! # Delegating (manager) agent
  childAgent: Agent! # Receiving (specialist) agent
  user: User! # Original user

  # Delegation Parameters
  amount: BigDecimal! # Delegated amount (wei)
  duration: BigInt! # Duration in seconds

  # Timing
  createdAt: BigInt! # Unix timestamp
  expiresAt: BigInt! # Unix timestamp

  # Status
  isActive: Boolean! @index

  # Transaction Info
  txHash: String!

  # ERC-7710 Delegation Reference (if applicable)
  erc7710Delegation: ERC7710Delegation # Link to off-chain delegation
}

# ============================================
# ERC-7710 DELEGATION ENTITIES
# ============================================

"""
ERC-7710 Signed Delegation
Represents an off-chain signed delegation that grants capabilities
from a delegator (Smart Account) to a delegate (agent).
Used in A2A (Agent-to-Agent) redelegation flows.
"""
type ERC7710Delegation @entity {
  id: ID! # Delegation hash
  delegator: String! @index # Smart Account that signed the delegation
  delegate: String! @index # Address that can redeem (specialist agent wallet)

  # Related Entities
  delegatorAgent: Agent # Fund Manager agent (if known)
  delegateAgent: Agent # Specialist agent (if known)
  originalUser: User # User who originally granted permission

  # Authority Chain
  authority: String! # Authority type (root or parent delegation hash)
  isRootAuthority: Boolean! @index # True if this is a root delegation

  # Signature
  signature: String! # EIP-712 signature

  # Caveats (Restrictions)
  caveatsCount: Int! # Number of caveats
  caveats: [DelegationCaveat!]! @derivedFrom(field: "delegation")

  # Redemption Status
  isRedeemed: Boolean! @index # Whether delegation has been redeemed
  redemptionTxHash: String # Transaction hash of redemption
  redemptionBlockNumber: BigInt # Block number of redemption

  # Timing
  createdAt: BigInt! # Unix timestamp when created
  expiresAt: BigInt # Unix timestamp when expires (from timestamp caveat)
  redeemedAt: BigInt # Unix timestamp when redeemed

  # Amount (from ERC20TransferAmount caveat if present)
  amount: BigDecimal # Amount limit (wei)
  amountUsed: BigDecimal # Amount used (wei)

  # Metadata
  salt: String! # Unique salt for this delegation
}

"""
DelegationCaveat represents a restriction on an ERC-7710 delegation.
Caveats are enforced on-chain by enforcer contracts.
"""
type DelegationCaveat @entity {
  id: ID! # delegation-index
  delegation: ERC7710Delegation!
  index: Int! # Position in caveats array

  # Enforcer
  enforcer: String! # Enforcer contract address
  enforcerType: String # Human-readable type (timestamp, limitedCalls, etc.)

  # Terms
  terms: String! # ABI-encoded terms (hex)
  termsDecoded: String # Human-readable decoded terms (JSON)
}

"""
DelegationRedemptionEvent tracks when a delegation is redeemed on-chain.
Indexed from DelegationManager contract events.
"""
type DelegationRedemptionEvent @entity {
  id: ID! # txHash-logIndex
  delegation: ERC7710Delegation! # The delegation being redeemed

  # Execution Details
  redeemer: String! @index # Address that submitted the redemption
  target: String! # Target contract of the execution
  value: BigDecimal! # ETH value sent (wei)
  callData: String! # Execution calldata (hex)

  # Result
  success: Boolean! # Whether redemption succeeded
  returnData: String # Return data from execution

  # Transaction Info
  txHash: String!
  blockNumber: BigInt!
  timestamp: BigInt!
  gasUsed: BigInt
}

# ============================================
# ANALYTICS ENTITIES
# ============================================

type AgentDailyStat @entity {
  id: ID! # agent-date
  agent: Agent!
  date: String! # YYYY-MM-DD format
  timestamp: BigInt! # Start of day timestamp

  # Daily Metrics
  executionCount: BigInt!
  successCount: BigInt!
  failureCount: BigInt!
  volumeIn: BigDecimal!
  volumeOut: BigDecimal!
  profitLoss: BigDecimal!
  winRate: BigDecimal!

  # Rankings
  dailyRank: Int # Rank for this day
}

type GlobalStats @entity {
  id: ID! # "global"

  # Counts
  totalAgents: BigInt!
  activeAgents: BigInt!
  totalUsers: BigInt!
  totalExecutions: BigInt!
  totalPermissions: BigInt!
  activePermissions: BigInt!
  totalRedelegations: BigInt!

  # Volume
  totalVolumeProcessed: BigDecimal!
  totalProfitGenerated: BigDecimal!

  # Timestamps
  lastUpdated: BigInt!
}

type LeaderboardSnapshot @entity {
  id: ID! # timestamp
  timestamp: BigInt!
  rankings: [LeaderboardEntry!]! @derivedFrom(field: "snapshot")
}

type LeaderboardEntry @entity {
  id: ID! # snapshot-rank
  snapshot: LeaderboardSnapshot!
  agent: Agent!
  rank: Int!
  reputationScore: Int!
  winRate: BigDecimal!
  totalVolume: BigDecimal!
  profitLoss: BigDecimal!
}

# ============================================
# ERC-8004 REPUTATION ENTITIES
# ============================================

type Feedback @entity {
  id: ID! # Composite: agentId-clientAddress-index
  agent: Agent! # The agent receiving feedback
  clientAddress: String! @index # Address of client giving feedback

  # Feedback Details
  score: Int! # 0-100 score
  tag1: String! # Primary categorization tag (bytes32 as hex)
  tag2: String! # Secondary tag (bytes32 as hex)
  fileUri: String # URI to detailed feedback file
  fileHash: String # Hash of feedback file

  # Status
  isRevoked: Boolean! @index # Whether feedback was revoked

  # Timestamps
  createdAt: BigInt! # When feedback was submitted
  revokedAt: BigInt # When feedback was revoked (if applicable)

  # Transaction Info
  txHash: String!
  blockNumber: BigInt!

  # Relationships
  responses: [FeedbackResponse!]! @derivedFrom(field: "feedback")
}

type FeedbackResponse @entity {
  id: ID! # Composite: feedbackId-responseIndex
  feedback: Feedback! # The feedback being responded to
  responder: String! @index # Address of responder

  # Response Details
  responseUri: String! # URI to response content
  responseHash: String! # Hash of response content

  # Timestamps
  createdAt: BigInt!

  # Transaction Info
  txHash: String!
  blockNumber: BigInt!
}

# ============================================
# ERC-8004 VALIDATION ENTITIES
# ============================================

type ValidationRequest @entity {
  id: ID! # requestHash (bytes32 as hex)
  agent: Agent! # Agent being validated
  validator: String! @index # Validator address
  requester: String! @index # Who created the request

  # Request Details
  requestUri: String! # URI to request details

  # Response Details (populated when validator responds)
  hasResponse: Boolean! @index # Whether validator has responded
  response: Int # 0-100 validation score (null if pending)
  responseUri: String # URI to response content
  responseHash: String # Hash of response
  tag: String # Categorization tag

  # Timestamps
  requestedAt: BigInt! # When request was created
  respondedAt: BigInt # When response was submitted

  # Transaction Info
  requestTxHash: String!
  responseTxHash: String
  blockNumber: BigInt!
}

type Validator @entity {
  id: ID! # Validator address
  totalRequests: BigInt! # Total validation requests received
  completedRequests: BigInt! # Total validations completed
  avgResponseScore: BigDecimal! # Average response score given

  # Timestamps
  firstRequestAt: BigInt # First request timestamp
  lastActivityAt: BigInt # Last activity timestamp

  # Relationships
  validations: [ValidationRequest!]! @derivedFrom(field: "validator")
}

# ============================================
# AGENT REPUTATION SUMMARY
# ============================================

type AgentReputationSummary @entity {
  id: ID! # agentId
  agent: Agent!

  # Feedback Metrics
  totalFeedbackCount: BigInt!
  activeFeedbackCount: BigInt! # Excluding revoked
  avgFeedbackScore: BigDecimal!

  # Validation Metrics
  totalValidationRequests: BigInt!
  completedValidations: BigInt!
  avgValidationScore: BigDecimal!

  # Combined Score (0-100)
  combinedReputationScore: Int!

  # Timestamps
  lastUpdated: BigInt!
}
